# A5: Relational schema, validation and schema refinement

Our project, Answerly, is a web application for collaborative Questions and Answers.

This artifact contains the Relational Schema obtained by mapping from the Conceptual Data Model. The Relational Schema includes the relation schema, attributes, domains, primary keys, foreign keys and other integrity rules: UNIQUE, DEFAULT, NOT NULL, CHECK...

## 1. Relational Schema

In the generalizations that include Administrator as a subclass of Moderator, and this last one as a subclass of User, we chose the __Use Nulls__ technique for representing the relations, because they are heavily overlapping and with only one subclass per generalization.

|Relation Reference     |   Relation Compact Notation|
|-----------------------|----------------------------|
|R01                |    user(__userID__, firstName *NN*, lastName *NN*, email *UK* *NN*, description, username *UK* *NN*, password *NN*, score *DF 0*)                       |
|R02                |    label(__labelID__, name *NN*)                       |
|R03                |    notification(__notificationID__, content *NN*, date *DF Today*, viewed *DF False*, userID → user *NN*)                       |
|R04                |    user_management(__managementID__, state *NN*, status *NN*, userID → user *NN*)                       |                  |
|R05                |    vote(__voteID__, like, dislike, userID → user *NN*, questionID → question, answerID → answer *CK questionID = NN XOR answerID = NN*)                       |
|R06                    |question(__questionID__, userID → user *NN*, title *NN*, description *NN*, nrLikes *NN* *DF 0*, nrDislikes *NN* *DF 0*, questionDate *NN DF Today*)|
|R07                    |answer(__answerID__, userID → user *NN*, questionID → question *NN*, answerDate *NN DF Today*, content *NN*, nrLikes *NN* *DF 0*, nrDislikes *NN* *DF 0*)|
|R08                    |comment(__commentID__, userID → user *NN*, questionID→Question, answerID→Answer *CK questionID = NN XOR answerID = NN*, content *NN*, commentDate *NN DF Today*)|
|R09                    |report(__reportID__, userID→User, questionID→Question, answerID→Answer, commentID→Comment *CK userID = NN XOR questionID = NN XOR answerID = NN XOR commentID = NN*)| 
|R10                    |report_status(__statusID__, reportID → Report, state *NN DF unresolved CK state IN States*, comment, responsibleUser→Moderator *NN*)|
|R11                    |marked_answer(__questionID__ → question, __answerID__ → answer)|
|R12                |    following(__userID__ → user, __labelID__ → label))                       |
|R13                    |about(__questionID__ → question, __labelID__ → label)|

* UK means UNIQUE KEY
* NN means NOT NULL
* DF means DEFAULT
* CK means CHECK

## 2. Domains

Specification of additional domains:

|Domain Name        |Domain Specification                               |
|-------------------|---------------------------------------------------|
|Today              |DATE DEFAULT CURRENT DATE                          |
|States             |ENUM ('unresolved', 'reviewing', 'resolved')       |


## 3. Functional Dependencies and schema validation

In the following tables, all relations are in the Boyce-Codd Normal Form, since for each non trivial functional dependency A → B, A is a (super)key of the relation.

| **Table R01** (user) | |
|---|---|
| **Keys**: {userID}, {username}, {email} | |
| **Functional Dependencies** | |
| FD0101 |  {userID} → {firstName, lastName, email, description, username, password, score} |
| FD0102 |  {username} → {userID, firstName, lastName, email, description, password, score} |
| FD0103 |  {email} → {userID, firstName, lastName, description, username, password, score} |
| **NORMAL FORM** | BCNF |

---

| **Table R02** (label) | |
|---|---|
| **Keys**: {labelID} | |
| **Functional Dependencies** | |
| FD0201 | {labelID} → {name} |
| **NORMAL FORM** | BCNF |

---

| **Table R03** (notification) | |
|---|---|
| **Keys**: {notificationID} | |
| **Functional Dependencies** | |
| FD0301 | {notificationID} → {content, date, viewed, userID} |
| **NORMAL FORM** | BCNF |

---

| **Table R04** (user_management) | |
|---|---|
| **Keys**: {managementID} | |
| **Functional Dependencies** | |
| FD0401 | {managementID} → {state, status, userID} |
| **NORMAL FORM** | BCNF |

---

| **Table R05** (vote) | |
|---|---|
| **Keys**: {voteID} | |
| **Functional Dependencies** | |
| FD0501 | {voteID} → {like, dislike, userID, questionID, answerID} |
| **NORMAL FORM** | BCNF |

---

| **Table R06** (question) | |
|---|---|
| **Keys**: {questionID} | |
| **Functional Dependencies** | |
| FD0601 | {questionID} → {userID, title, description, nrLikes, nrDislikes, questionDate} |
| **NORMAL FORM** | BCNF |

---

| **Table R07** (answer) | |
|---|---|
| **Keys**: {answerID} | |
| **Functional Dependencies** | |
| FD0701 | {answerID} → {userID, questionID, answerDate, content, nrLikes, nrDislikes} |
| **NORMAL FORM** | BCNF |

---

| **Table R08** (comment) | |
|---|---|
| **Keys**: {commentID} | |
| **Functional Dependencies** | |
| FD0801 | {commentID} → {userID, questionID, answerID, content, commentDate} |
| **NORMAL FORM** | BCNF |

---

| **Table R09** (report) | |
|---|---|
| **Keys**: {reportID} | |
| **Functional Dependencies** | |
| FD0901 | {reportID} → {userID, questionID, answerID, commentID} |
| **NORMAL FORM** | BCNF |

---

| **Table R10** (report_status) | |
|---|---|
| **Keys**: {statusID} | |
| **Functional Dependencies** | |
| FD1001 | {statusID} → {reportID, state, comment, responsibleUser} |
| **NORMAL FORM** | BCNF |

---

| **Table R11** (marked_answer) | |
|---|---|
| **Keys**: {questionID, answerID} | |
| **Functional Dependencies** | |
| (none) | |
| **NORMAL FORM** | BCNF |

---

| **Table R12** (following) | |
|---|---|
| **Keys**: {userID, labelID} | |
| **Functional Dependencies** | |
| (none) | |
| **NORMAL FORM** | BCNF |

---

| **Table R13** (about) | |
|---|---|
| **Keys**: {questionID, labelID} | |
| **Functional Dependencies** | |
| (none) | |
| **NORMAL FORM** | BCNF |


## 4. SQL Code

```sql
PRAGMA foreign_keys = off;

-- Table: User
DROP TABLE IF EXISTS User;
CREATE TABLE User (
    userID          SERIAL          PRIMARY KEY,
    firstName       TEXT            NOT NULL,
    lastName        TEXT            NOT NULL,
    email           TEXT            NOT NULL,
    description     TEXT,
    username        TEXT            NOT NULL UNIQUE,
    password        TEXT            NOT NULL,
    score           INTEGER         DEFAULT 0              
);

-- Table: Label
DROP TABLE IF EXISTS Label;
CREATE TABLE Label (
    labelID         SERIAL          PRIMARY KEY,
    name            TEXT            NOT NULL          
);

-- Table: Notification
DROP TABLE IF EXISTS Notification;
CREATE TABLE Notification (
    notificationID  SERIAL          PRIMARY KEY,
    content         TEXT            NOT NULL,
    date            DATE            DEFAULT 'today' NOT NULL,
    viewed          BOOLEAN         DEFAULT FALSE,
    userID          INTEGER         REFERENCES "User" (userID)
);

-- Table: UserManagement
DROP TABLE IF EXISTS UserManagement;
CREATE TABLE UserManagement (
    managementID    SERIAL          PRIMARY KEY,
    state           TEXT            DEFAULT 'active' NOT NULL,
    status          TEXT            DEFAULT 'user' NOT NULL,
    userID          INTEGER         REFERENCES "User" (userID)
);

-- Table: Moderator
DROP TABLE IF EXISTS Moderator;
CREATE TABLE Moderator (
    moderatorID     INTEGER         REFERENCES "User" (userID)
);

-- Table: Administrator
DROP TABLE IF EXISTS Administrator;
CREATE TABLE Administrator (
    administratirID INTEGER         REFERENCES "Moderator" (moderatorID)
);

-- Table: Question
DROP TABLE IF EXISTS Question;
CREATE TABLE Question (
    questionID      SERIAL          PRIMARY KEY,
    userID          INTEGER         REFERENCES "User" (userID),
    title           TEXT            NOT NULL,
    description     TEXT            NOT NULL,
    nrLikes         INTEGER         DEFAULT 0 NOT NULL,
    nrDislikes      INTEGER         DEFAULT 0 NOT NULL,
    questionDate    DATE            DEFAULT 'today' NOT NULL           
);

-- Table: Answer
DROP TABLE IF EXISTS Answer;
CREATE TABLE Answer (
    answerID        SERIAL          PRIMARY KEY,
    userID          INTEGER         REFERENCES "User" (userID),
    questionID      INTEGER         REFERENCES "Question" (questionID),
    answerDate      DATE            DEFAULT 'today' NOT NULL,
    content         TEXT            NOT NULL,
    nrLikes         INTEGER         DEFAULT 0 NOT NULL,
    nrDislikes      INTEGER         DEFAULT 0 NOT NULL
);

-- Table: Comment
DROP TABLE IF EXISTS Comment;
CREATE TABLE Comment (
    commentID       SERIAL          PRIMARY KEY,
    userID          INTEGER         REFERENCES "User" (userID),
    questionID      INTEGER         REFERENCES "Question" (questionID),
    answerID        INTEGER         REFERENCES "Answer" (answerID),
    commentDate     DATE            DEFAULT 'today' NOT NULL,
    content         TEXT            NOT NULL,
    CHECK (
        (questionID IS NOT NULL AND answerID IS NULL) OR
        (questionID IS NULL AND answerID IS NOT NULL)
    )
);

-- Table: Vote
DROP TABLE IF EXISTS Vote;
CREATE TABLE Vote (
    voteID          SERIAL          PRIMARY KEY,
    like            BOOLEAN,
    dislike         BOOLEAN,
    userID          INTEGER         REFERENCES "User" (userID),
    questionID      INTEGER         REFERENCES "Question" (questionID),
    answerID        INTEGER         REFERENCES "Answer" (answerID),
    CHECK (
        (questionID IS NOT NULL AND answerID IS NULL) OR
        (questionID IS NULL AND answerID IS NOT NULL)
    )
);

-- Table: Report
DROP TABLE IF EXISTS Report;
CREATE TABLE Report (
    reportID        SERIAL          PRIMARY KEY,
    userID          INTEGER         REFERENCES "User" (userID),
    questionID      INTEGER         REFERENCES "Question" (questionID),
    answerID        INTEGER         REFERENCES "Answer" (answerID),   
    commentID       INTEGER         REFERENCES "Comment" (commentID),
    CHECK(
        (userID IS NOT NULL AND questionID IS NULL AND answerID IS NULL AND commentID IS NULL) OR
        (userID IS NULL AND questionID IS NOT NULL AND answerID IS NULL AND commentID IS NULL) OR
        (userID IS NULL AND questionID IS NULL AND answerID IS NOT NULL AND commentID IS NULL) OR
        (userID IS NULL AND questionID IS NULL AND answerID IS NULL AND commentID IS NOT NULL)
    )
);

-- Table: ReportStatus
DROP TABLE IF EXISTS ReportStatus;
CREATE TABLE ReportStatus (
    statusID        SERIAL          PRIMARY KEY,
    reportID        INTEGER         REFERENCES "Report" (reportID),
    state           TEXT            DEFAULT 'unresolved' NOT NULL,
    comment         TEXT,
    responsibleUser INTEGER         REFERENCES "Moderator" (moderatorID)
);

-- Table: MarkedAnswer
DROP TABLE IF EXISTS MarkedAnswer;
CREATE TABLE MarkedAnswer (
    questionID      INTEGER         REFERENCES "Question" (questionID),
    answerID        INTEGER         REFERENCES "Answer" (answerID)
);

-- Table: Following
DROP TABLE IF EXISTS Following;
CREATE TABLE Following (
    userID          INTEGER         REFERENCES "User" (userID),
    labelID         INTEGER         REFERENCES "Label" (labelID)
);

-- Table: About
DROP TABLE IF EXISTS About;
CREATE TABLE About (
    questionID      INTEGER         REFERENCES "Question" (questionID),
    labelID         INTEGER         REFERENCES "Label" (labelID)
);
```


## Revision history

1. First submission (23/03/2020).

------

GROUP2064, 23/03/2020

- [Editor] Antonio Pedro Reis Ribeiro Sousa Dantas, up201703878@fe.up.pt
- Eduardo João Santana Macedo, up201703658@fe.up.pt
- Nuno Miguel Teixeira Cardoso, up201706162@fe.up.pt
- Paulo Roberto Dias Mourato, up201705616@fe.up.pt

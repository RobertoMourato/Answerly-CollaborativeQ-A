# A6: Indexes, triggers, user functions, transactions and population

> Brief presentation of the product.  
> Brief presentation of the artefact goals.

## 1. Database Workload
 
> A study of the predicted system load (database load), organized in subsections.
 
### 1.1. Tuple Estimation
 
> Estimate of tuples at each relation.  

| **Relation reference** | **Relation Name** | **Order of magnitude**        | **Estimated growth** |
| ------------------ | ------------- | ------------------------- | -------- |
| R01                | Table1        | units|dozens|hundreds|etc | order per time |
| R02                | Table2        | units|dozens|hundreds|etc | dozens per month |
| R03                | Table3        | units|dozens|hundreds|etc | hundreds per day |
| R04                | Table4        | units|dozens|hundreds|etc | no growth |

### 1.2. Frequent Queries
 
> Most important queries (SELECT) and their frequency.  

| **Query**       | SELECT01                               |
| ---             | ---                                    |
| **Description** | Gets questions with most likes |
| **Frequency**   | thousands per day                     |

 **SQL code** 
```sql
SELECT * FROM question
ORDER BY question.nr_likes desc
LIMIT 30; 
```

| **Query**       | SELECT02                               |
| ---             | ---                                    |
| **Description** | Gets most recent questions |
| **Frequency**   | thousands per day                     |

 **SQL code** 
```sql
SELECT * FROM question
ORDER BY question.question_date desc
LIMIT 30; 
```

| **Query**       | SELECT03                               |
| ---             | ---                                    |
| **Description** | Gets most scored answers |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT * FROM question
ORDER BY answer.nr_likes desc
LIMIT 30; 
```

| **Query**       | SELECT04                               |
| ---             | ---                                    |
| **Description** | Gets most recent answers |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT * FROM question
ORDER BY answer.answer_date desc
LIMIT 30; 
```

| **Query**       | SELECT05                               |
| ---             | ---                                    |
| **Description** | Gets most recent comments |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT * FROM question
ORDER BY comment.comment_date desc
LIMIT 30; 
```

| **Query**       | SELECT06                             |
| ---             | ---                                    |
| **Description** | Gets most popular labels |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT * 
FROM label join about ON label.id = about.label_id
JOIN question ON question.id = about.question_id
GROUP BY label.id
LIMIT 5; 
```

| **Query**       | SELECT07                             |
| ---             | ---                                    |
| **Description** | Gets most popular questions within label |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT label.name 
FROM label join about ON label.id = about.label_id
JOIN question ON question.id = about.question_id
WHERE label.name = $label_name
ORDER BY question.nr_likes desc
LIMIT 20; 
```

| **Query**       | SELECT08                             |
| ---             | ---                                    |
| **Description** | Gets most recent questions within label |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT label.name 
FROM label join about ON label.id = about.label_id
JOIN question ON question.id = about.question_id
WHERE label.name = $label_name
ORDER BY question.question_date desc
LIMIT 20; 
```

| **Query**       | SELECT09                             |
| ---             | ---                                    |
| **Description** | Gets all user's question, score and answers |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT * 
FROM "user" u join question ON u.id = question.user_id
JOIN answer ON u.id = answer.user_id
WHERE u.id = $id;
```

| **Query**       | SELECT10                             |
| ---             | ---                                    |
| **Description** | Gets all notifications order by date of a given user |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT * 
FROM "user" u join notification ON u.id = notification.user_id
WHERE u.id = $id
ORDER BY notification.date desc;
```


| **Query**       | SELECT11                             |
| ---             | ---                                    |
| **Description** | Gets user info |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT name, bio, first_name, last_name, score
FROM "user" u 
WHERE u.id = $id
```

| **Query**       | SELECT12                            |
| ---             | ---                                    |
| **Description** | Gets a label with string |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT name
FROM label 
WHERE name LIKE '%$string%'
ORDER BY notification.date desc;
```

| **Query**       | SELECT13                             |
| ---             | ---                                    |
| **Description** | Gets a question with string |
| **Frequency**   | hundreds per day                     |

 **SQL code** 
```sql
SELECT name
FROM question 
WHERE description LIKE '%$string%' --probablywrong
ORDER BY notification.date desc;
```

| **Query**       | SELECT14                             |
| ---             | ---                                    |
| **Description** | Gets questions reports |
| **Frequency**   | dozens per day                     |

 **SQL code** 
```sql
SELECT state, comment, responsible_user
FROM report 
WHERE answer_id IS NULL
AND comment_id IS NULL;
```

| **Query**       | SELECT15                             |
| ---             | ---                                    |
| **Description** | Gets answers reports |
| **Frequency**   | dozens per day                     |

 **SQL code** 
```sql
SELECT state, comment, responsible_user
FROM report 
WHERE question_id IS NULL
AND comment_id IS NULL;
```

| **Query**       | SELECT16                             |
| ---             | ---                                    |
| **Description** | Gets comments reports |
| **Frequency**   | dozens per day                     |

 **SQL code** 
```sql
SELECT state, comment, responsible_user
FROM report 
WHERE question_id IS NULL
AND answer_id IS NULL;
```

| **Query**       | SELECT17                             |
| ---             | ---                                    |
| **Description** | Gets user reports |
| **Frequency**   | dozens per day                     |

 **SQL code** 
```sql
SELECT *
FROM report 
WHERE user_id IS NOT NULL
GROUP BY user_id;  -- Ver ordem
```

| **Query**       | SELECT18                             |
| ---             | ---                                    |
| **Description** | Gets users with most scores |
| **Frequency**   | dozens per day                     |

 **SQL code** 
```sql
SELECT *
FROM "user" u join user_management on u.id = user_management.user_id
where user_management.status == 'normal'
ORDER BY score desc
LIMIT 30;
```

| **Query**       | SELECT19                             |
| ---             | ---                                    |
| **Description** | Gets moderators with most scores |
| **Frequency**   | dozens per day                     |

 **SQL code** 
```sql
SELECT *
FROM "user" u join user_management on u.id = user_management.user_id
where user_management.status == 'moderator'
ORDER BY score desc
LIMIT 30;
```

| **Query**       | SELECT20                             |
| ---             | ---                                    |
| **Description** | Get question info |
| **Frequency**   | dozens per day                     |

 **SQL code** 
```sql
SELECT *
FROM question WHERE id = $id;
```

| **Query**       | SELECT21                             |
| ---             | ---                                    |
| **Description** | Get comment info |
| **Frequency**   | dozens per day                     |

 **SQL code** 
```sql
SELECT *
FROM comment WHERE id = $id;
```


| **Query**       | SELECT23                             |
| ---             | ---                                    |
| **Description** | Get a user's score |
| **Frequency**   | dozens per day                     |

 **SQL code** 
```sql
SELECT score
FROM "user" u WHERE u.id = $id;
```






### 1.3. Frequent Updates

> Most important updates (INSERT, UPDATE, DELETE) and their frequency.  

| **Query**       | UPDATE01                               |
| ---             | ---                                    |
| **Description** | One sentence describing the query goal |
| **Frequency**   | magnitude per time                     |
| **SQL code**    |                                        |

## 2. Proposed Indices

### 2.1. Performance Indices

> Indices proposed to improve performance of the identified queries. B-Tree is used when we want to grab chunks of data, whilst Hash is used to grab specific database elements.   

| **Index**           | IDX01                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT01, SELECT07, SELECT23           |
| **Relation**        | question                               |
| **Attribute**       | nr_likes                               |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching questions ordered by score faster.                                                        |
```sql
CREATE INDEX question_score ON question USING btree(nr_likes)
```

| **Index**           | IDX02                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT02, SELECT08                     |
| **Relation**        | question                               |
| **Attribute**       | question_date                          |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching questions ordered by date faster.                                                        |
```sql
CREATE INDEX question_date ON question USING btree(question_date)
```

| **Index**           | IDX03                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT03                               |
| **Relation**        | answer                                 |
| **Attribute**       | question_id, nr_likes                  |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching answers to a specific question ordered by score faster.                                                        |
```sql
CREATE INDEX answer_score ON answer USING btree(quesiton_id, nr_likes)
```

| **Index**           | IDX04                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT04                               |
| **Relation**        | answer                                 |
| **Attribute**       | question_id, answer_date               |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching answers to a specific question ordered by date faster.                                                        |
```sql
CREATE INDEX answer_date ON answer USING btree(question_id, answer_date)
```

| **Index**           | IDX05                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT05                               |
| **Relation**        | comment                                |
| **Attribute**       | question_id, comment_date              |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching comments to a specific question ordered by date faster.                                                        |
```sql
CREATE INDEX comment_date ON comment USING btree(quesiton_id, comment_date)
```

| **Index**           | IDX06                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT06                               |
| **Relation**        | following                              |
| **Attribute**       | label_id                               |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching for the most popular labels faster.                                                        |
```sql
CREATE INDEX label_popularity ON following USING btree(label_id)
```

| **Index**           | IDX07                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT09                               |
| **Relation**        | question                               |
| **Attribute**       | user_id                                |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching for a user's number of questions faster.                                                        |
```sql
CREATE INDEX question_user ON question USING btree(user_id)
```

| **Index**           | IDX08                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT09                               |
| **Relation**        | answer                                 |
| **Attribute**       | user_id                                |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching for a user's number of answers faster.                                                        |
```sql
CREATE INDEX answer_user ON answer USING btree(user_id)
```

| **Index**           | IDX09                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT10                               |
| **Relation**        | notification                           |
| **Attribute**       | user_id, date                          |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching for a user's number of notifications ordered by date faster.                                                        |
```sql
CREATE INDEX notification_user_date ON notification USING btree(user_id, date)
```

| **Index**           | IDX10                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT11                               |
| **Relation**        | user                                   |
| **Attribute**       | email                                  |
| **Type**            | Hash                                   |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow retrieving user information faster, based on the email                                                        |
```sql
CREATE INDEX user_email ON user USING hash(email)
```

| **Index**           | IDX11                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT17                               |
| **Relation**        | report                                 |
| **Attribute**       | user_id                                |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching for the number of reports a user has received                                                        |
```sql
CREATE INDEX report_user ON report USING btree(user_id)
```

| **Index**           | IDX12                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT18, SELECT19                     |
| **Relation**        | user                                   |
| **Attribute**       | score                                  |
| **Type**            | B-tree                                 |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To allow searching for users and moderators ordered by score faster                                                       |
```sql
CREATE INDEX user_score ON user USING btree(score)
```

### 2.2. Full-text Search Indices 

> GIN is used for infrequently updated tables, leading to faster lookups. GiST is better for dynamic data.

| **Index**           | IDX13                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT12                               |
| **Relation**        | label                                  |
| **Attribute**       | name                                   |
| **Type**            | GIN                                    |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To enhance performance of full text searches on label names                                                       |
```sql
CREATE INDEX label_name ON user USING gin(name)
```

| **Index**           | IDX14                                  |
| ---                 | ---                                    |
| **Related queries** | SELECT13                               |
| **Relation**        | question                               |
| **Attribute**       | title                                  |
| **Type**            | GiST                                   |
| **Cardinality**     | Attribute cardinality: low/medium/high |
| **Clustering**      | No                                     |
| **Justification**   | To enhance performance of full text searches on question titles                                                       |
```sql
CREATE INDEX question_title ON question USING gist(to_tsvector('english', title))
```

## 3. Triggers
 
> User-defined functions and trigger procedures that add control structures to the SQL language or perform complex computations, are identified and described to be trusted by the database server. Every kind of function (SQL functions, Stored procedures, Trigger procedures) can take base types, composite types, or combinations of these as arguments (parameters). In addition, every kind of function can return a base type or a composite type. Functions can also be defined to return sets of base or composite values.  

| **Trigger**      | TRIGGER01                              |
| ---              | ---                                    |
| **Description**  | Trigger description, including reference to the business rules involved |
| **SQL code**    |                                         |

## 4. Transactions
 
> Transactions needed to assure the integrity of the data.  

| SQL Reference   | Transaction Name                    |
| --------------- | ----------------------------------- |
| Justification   | Justification for the transaction.  |
| Isolation level | Isolation level of the transaction. |
| `Complete SQL Code`                                   |

## 5. SQL Code

> The database script must also include the SQL to populate a database with test data with an amount of tuples suitable for testing and with plausible values for the fields of the database.  
> This code should also be included in the group's git repository as an SQL script, and a link include here.  

### 5.1. Database schema

### 5.2. Database population

## Revision history

Changes made to the first submission:
1. Item 1
1. ..

***
GROUP20gg, DD/MM/2020

* Group member 1 name, email (Editor)
* Group member 2 name, email
* ...
